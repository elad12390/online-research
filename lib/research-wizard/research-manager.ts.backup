/**
 * Research Manager
 * Orchestrates research projects using Claude Agent SDK and manages the workflow
 */

import * as path from "path"
import * as fs from "fs"
import { spawn } from "child_process"
import { ResearchDatabase } from "./research-wizard-db"
import { v4 as uuidv4 } from "uuid"
import { researchLogger } from "@/lib/logger"

interface ResearchConfig {
  topic: string
  depth: "quick" | "standard" | "deep"
  focus?: string
  style?: "comprehensive" | "comparing" | "practical"
}

interface ProgressUpdate {
  percentage: number
  currentTask: string
  currentTaskDescription: string
  completedTasks: string[]
  startedAt: string
  estimatedCompletion: string
}

export class ResearchManager {
  private db: ResearchDatabase
  private baseResearchDir: string

  constructor(
    _baseUrl?: string,
    baseResearchDir: string = "./research-projects"
  ) {
    this.baseResearchDir = baseResearchDir
    this.db = new ResearchDatabase(path.join(baseResearchDir, "research-wizard.db"))
  }

  /**
   * Create and start a new research project
   */
  async startResearch(config: ResearchConfig): Promise<string> {
    const researchId = uuidv4()
    const projectDir = this.createProjectDirectory(config.topic, researchId)

    // Create research record in database
    this.db.createResearch(researchId, config.topic, projectDir)

    // Initialize progress file
    this.initializeProgressFile(projectDir)

    // Create initial README
    this.createReadme(projectDir, config)

    // Log startup activity
    const agentRecord = this.db.createAgent(researchId, "Research Agent")
    this.db.logActivity(
      agentRecord.id,
      "research_started",
      `Starting research on: ${config.topic}`,
      config
    )

    // Spawn research agent asynchronously
    this.spawnResearchAgent(researchId, projectDir, config, agentRecord.id)

    return researchId
  }

  /**
   * Spawn the research agent as a background task
   */
  private async spawnResearchAgent(
    researchId: string,
    projectDir: string,
    config: ResearchConfig,
    agentId: string
  ) {
    let startTime = 0
    try {
      startTime = Date.now()
      const correlationId = uuidv4().slice(0, 8)
      
      researchLogger.info("Starting research", {
        correlationId,
        researchId,
        topic: config.topic,
        depth: config.depth,
        style: config.style,
      })

      // Check for API key
      if (!process.env.ANTHROPIC_API_KEY) {
        throw new Error("ANTHROPIC_API_KEY environment variable is not set. Please set it to use the Claude Agent SDK.")
      }

      // Update agent status
      this.db.updateAgentStatus(agentId, "running")
      researchLogger.debug("Agent status updated to running", { correlationId, agentId })

      // Update research status
      this.db.updateResearchStatus(researchId, "in_progress")
      researchLogger.debug("Research status updated to in_progress", { correlationId, researchId })

      // Prepare the research prompt
      const prompt = this.buildResearchPrompt(config, projectDir)
      researchLogger.debug("Research prompt prepared", {
        correlationId,
        researchId,
        prompt_length: prompt.length,
      })

      // Configure Claude Agent SDK options
      const sdkOptions: Options = {
        cwd: projectDir,
        model: "claude-sonnet-4-5",  // Claude Sonnet 4.5 - best for agents and coding
        
        // Pass environment variables to Claude CLI process
        env: {
          ANTHROPIC_API_KEY: process.env.ANTHROPIC_API_KEY,
          HOME: process.env.HOME,
          PATH: process.env.PATH,
        },
        
        // MCP Configuration - Load web-research-assistant
        mcpServers: {
          "web-research-assistant": {
            type: "stdio",
            command: "uvx",
            args: ["web-research-assistant"],
          },
        },
        
        // Tool permissions - allow web-research-assistant MCP tools
        allowedTools: [
          // Web research assistant MCP tools (all tools from the server)
          "web-research-assistant_web_search",
          "web-research-assistant_crawl_url",
          "web-research-assistant_search_examples",
          "web-research-assistant_search_images",
          "web-research-assistant_compare_tech",
          "web-research-assistant_package_info",
          "web-research-assistant_extract_data",
          "web-research-assistant_translate_error",
          "web-research-assistant_api_docs",
          "web-research-assistant_github_repo",
          "web-research-assistant_get_changelog",
          "web-research-assistant_check_service_status",
          "web-research-assistant_package_search",
          
          // Built-in web tools (fallback)
          "WebSearch",
          "WebFetch",
          
          // File operations in project directory
          "Write",
          "Read",
        ],
        
        // Block dangerous tools
        disallowedTools: [
          "Bash",           // No bash execution
          "Edit",           // No editing (only Write/Read)
          "MultiEdit",
          "Task",           // No sub-agents
        ],
        
        // Permission mode - bypass permissions for automated research
        permissionMode: "bypassPermissions",
        
        // Capture stderr for debugging
        stderr: (data: string) => {
          console.error('[Claude SDK stderr]', data)
          researchLogger.debug("Claude stderr", {
            correlationId,
            researchId,
            stderr: data,
          })
        },
        
        // System prompt with clear instructions
        systemPrompt: `You are a research agent. Your task is to research "${config.topic}" and create comprehensive markdown documentation.

INSTRUCTIONS:
1. Use web-research-assistant MCP tools to gather information
2. Prefer web-research-assistant tools over built-in WebSearch/WebFetch for better quality results
3. Create well-structured markdown files with your findings
4. Save files as: 01-summary.md, 02-analysis.md, 03-recommendations.md, etc.
5. Include sources and citations with URLs
6. Use clear, professional language with specific data and facts

AVAILABLE TOOLS:
- web-research-assistant_web_search: Search the web
- web-research-assistant_crawl_url: Fetch and read web pages
- web-research-assistant_compare_tech: Compare technologies/products
- web-research-assistant_search_examples: Find code examples
- web-research-assistant_package_info: Get package information
- web-research-assistant_extract_data: Extract structured data
- WebSearch: Built-in web search (fallback)
- WebFetch: Built-in URL fetching (fallback)
- Write: Create markdown files
- Read: Read existing files

Start by using web-research-assistant tools to search for information about "${config.topic}", then create organized markdown files with your research.`,
        
        maxTurns: 30,
        maxBudgetUsd: 3.0,
      }

      researchLogger.info("Starting Claude Agent SDK query", {
        correlationId,
        researchId,
        cwd: projectDir,
        model: sdkOptions.model,
        mcp_servers: Object.keys(sdkOptions.mcpServers || {}),
        allowed_tools_count: sdkOptions.allowedTools?.length,
      })

      // Log full SDK options for debugging
      researchLogger.debug("Claude Agent SDK options", {
        correlationId,
        researchId,
        options: {
          model: sdkOptions.model,
          cwd: sdkOptions.cwd,
          permissionMode: sdkOptions.permissionMode,
          maxTurns: sdkOptions.maxTurns,
          maxBudgetUsd: sdkOptions.maxBudgetUsd,
          mcpServers: sdkOptions.mcpServers,
          allowedToolsCount: sdkOptions.allowedTools?.length,
          disallowedToolsCount: sdkOptions.disallowedTools?.length,
          hasApiKeyInEnv: !!sdkOptions.env?.ANTHROPIC_API_KEY,
          apiKeyPrefix: sdkOptions.env?.ANTHROPIC_API_KEY?.substring(0, 15),
        },
      })

      // Execute the query using Claude Agent SDK
      researchLogger.info("Executing query with Claude Agent SDK", {
        correlationId,
        researchId,
      })
      
      const queryGenerator = query({
        prompt,
        options: sdkOptions,
      })

      // Process streaming messages
      let collectedText: string[] = []
      let messageCount = 0
      
      for await (const message of queryGenerator) {
        messageCount++
        
        // Log message type
        researchLogger.debug("Received SDK message", {
          correlationId,
          researchId,
          message_type: message.type,
          message_count: messageCount,
        })
        
        // Handle different message types
        if (message.type === "assistant") {
          // Assistant response
          const content = message.message.content
          
          for (const block of content) {
            if (block.type === "text") {
              collectedText.push(block.text)
              researchLogger.info("Collected text block", {
                correlationId,
                researchId,
                text_length: block.text.length,
              })
            }
          }
          
          // Update progress
          const percentage = Math.min(85, 10 + (messageCount * 5))
          this.updateProgressFile(projectDir, percentage, "Generating Research", [
            "Topic Analysis",
            `Collected ${collectedText.length} text blocks`,
          ])
        } else if (message.type === "result") {
          // Final result
          researchLogger.info("Research completed", {
            correlationId,
            researchId,
            duration_ms: message.duration_ms,
            num_turns: message.num_turns,
            cost_usd: message.total_cost_usd,
          })
          
          this.db.logActivity(
            agentId,
            "research_completed",
            `Research completed in ${message.num_turns} turns, cost: $${message.total_cost_usd.toFixed(4)}`
          )
          
          // Process collected text
          if (collectedText.length > 0) {
            const fullText = collectedText.join("\n\n")
            await this.processResearchResponse(
              projectDir,
              fullText,
              config,
              agentId
            )
          } else {
            // No content generated - create placeholder
            const summaryContent = `# Research Summary\n\nResearch completed but no content was generated.`
            const summaryPath = path.join(projectDir, "01-summary.md")
            fs.writeFileSync(summaryPath, summaryContent)
            
            this.db.logActivity(agentId, "file_created", `Created: 01-summary.md`)
          }
        } else if (message.type === "system") {
          // System messages
          researchLogger.debug("System message", {
            correlationId,
            researchId,
            subtype: message.subtype,
          })
        }
      }

      // Update final progress
      researchLogger.debug("Updating progress to 100%", {
        correlationId,
        researchId,
      })
      this.updateProgressFile(projectDir, 100, "Research Complete", [
        "Topic Research",
        "Content Generation",
        "File Creation",
      ])

      // Update statuses
      researchLogger.debug("Marking research as completed", {
        correlationId,
        researchId,
      })
      this.db.updateAgentStatus(agentId, "completed", `Collected ${collectedText.length} text blocks`)
      this.db.updateResearchStatus(researchId, "completed", Date.now())

      this.db.logActivity(
        agentId,
        "files_created",
        `Created research files in ${projectDir}`
      )
      
      const totalTime = Date.now() - startTime
      researchLogger.logRequest({
        correlationId,
        researchId,
        topic: config.topic,
        duration_ms: totalTime,
        status: "success",
        agent_count: 1,
        files_created: 1,
      })
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error)
      const stack = error instanceof Error ? error.stack : undefined
      const totalTime = Date.now() - startTime
      
      researchLogger.error("Research execution failed", error, {
        researchId,
        duration_ms: totalTime,
      })
      
      this.db.updateAgentStatus(agentId, "failed", undefined, errorMsg)
      this.db.updateResearchStatus(researchId, "failed")
      this.db.logActivity(
        agentId,
        "error",
        `Research failed: ${errorMsg}`,
        { stack }
      )
    }
  }

  /**
   * Build the research prompt based on configuration
   */
  private buildResearchPrompt(config: ResearchConfig, projectDir: string): string {
    const depthInstructions = {
      quick: "Provide a concise 15-20 minute research summary",
      standard: "Provide a comprehensive 45-60 minute research",
      deep: "Provide an exhaustive in-depth research with multiple perspectives",
    }

    const styleInstructions = {
      comprehensive: "Create detailed, well-structured documentation with multiple sections",
      comparing: "Focus on comparisons and contrasts between options",
      practical: "Focus on practical, actionable insights and implementation",
    }

    return `
You are a research agent tasked with conducting thorough research on a topic.

TOPIC: ${config.topic}
${config.focus ? `FOCUS: ${config.focus}` : ""}
DEPTH: ${depthInstructions[config.depth]}
STYLE: ${styleInstructions[config.style || "comprehensive"]}

IMPORTANT INSTRUCTIONS:

1. USE WEB RESEARCH TOOLS:
   - Use web-research-assistant_web_search to search for information
   - Use web-research-assistant_crawl_url to read web pages
   - Use web-research-assistant_compare_tech to compare technologies/products
   - Use other web-research-assistant tools as needed

2. CREATE MARKDOWN FILES:
   - Save your research as numbered markdown files in the current directory
   - Name files like: 01-executive-summary.md, 02-detailed-analysis.md, 03-recommendations.md
   - Use the Write tool to create these files
   - Each file should be well-structured markdown with proper headings

3. RESEARCH STRUCTURE:
   Create files covering:
   - Executive Summary (key findings)
   - Detailed Analysis (main research content)
   - Comparisons (if applicable)
   - Recommendations (actionable advice)
   - Sources (list of URLs and references)

4. WRITING STYLE:
   - Use clear, professional language
   - Include specific data, numbers, and facts
   - Cite sources with URLs
   - Use markdown formatting (headers, lists, tables, code blocks)

Begin your research now. Use web-research-assistant tools to gather information, then create well-organized markdown files with your findings.
`
  }

  /**
   * Process AI response and create markdown files
   */
  private async processResearchResponse(
    projectDir: string,
    fullText: string,
    config: ResearchConfig,
    agentId: string
  ) {
    // Parse content into sections
    const sections = this.parseContent(fullText)
    
    let fileCount = 1
    const files: string[] = []

    for (const section of sections) {
      const fileName = `${String(fileCount).padStart(2, "0")}-${this.slugify(
        section.title
      )}.md`
      const filePath = path.join(projectDir, fileName)

      fs.writeFileSync(
        filePath,
        `# ${section.title}\n\n${section.content}`
      )

      files.push(fileName)
      fileCount++

      this.db.logActivity(
        agentId,
        "file_created",
        `Created: ${fileName}`,
        { size: section.content.length }
      )
    }
  }

  /**
   * Parse content into sections based on markdown structure
   */
  private parseContent(text: string): Array<{ title: string; content: string }> {
    const sections: Array<{ title: string; content: string }> = []
    const lines = text.split("\n")
    let currentSection = { title: "Overview", content: "" }

    for (const line of lines) {
      if (line.startsWith("# ") || line.startsWith("## ")) {
        if (currentSection.content.trim()) {
          sections.push(currentSection)
        }
        const title = line.replace(/^#+\s*/, "").trim()
        currentSection = { title, content: "" }
      } else {
        currentSection.content += line + "\n"
      }
    }

    if (currentSection.content.trim()) {
      sections.push(currentSection)
    }

    return sections
  }

  /**
   * Create project directory structure
   */
  private createProjectDirectory(topic: string, researchId: string): string {
    const dirName = `${this.slugify(topic)}-${researchId.substring(0, 8)}`
    const projectDir = path.join(this.baseResearchDir, dirName)

    if (!fs.existsSync(projectDir)) {
      fs.mkdirSync(projectDir, { recursive: true })
    }

    // Create code subdirectory for examples
    const codeDir = path.join(projectDir, "code")
    if (!fs.existsSync(codeDir)) {
      fs.mkdirSync(codeDir, { recursive: true })
    }

    return projectDir
  }

  /**
   * Create initial README.md with metadata
   */
  private createReadme(projectDir: string, config: ResearchConfig) {
    const readmeContent = `---
title: Research on ${config.topic}
category: Consumer Product Research
tags:
  - ${config.topic}
  - Research
  - ${config.depth === "deep" ? "In-Depth" : "Standard"}
---

# ${config.topic}

## Quick Summary

Research project on **${config.topic}** initiated on ${new Date().toLocaleDateString()}.

${config.focus ? `**Focus**: ${config.focus}` : ""}
${config.style ? `**Style**: ${config.style}` : ""}

## Research Status

This research is currently being conducted by the AI research agent. Check back soon for detailed findings.

### Project Structure

- \`README.md\` - This file (project overview)
- \`01-*.md\` through \`0N-*.md\` - Detailed research documents
- \`code/\` - Code examples and samples (if applicable)

---

*Generated automatically by Research Wizard*
`

    fs.writeFileSync(path.join(projectDir, "README.md"), readmeContent)
  }

  /**
   * Initialize progress file for Research Portal sync
   */
  private initializeProgressFile(projectDir: string) {
    const progress: ProgressUpdate = {
      percentage: 0,
      currentTask: "Initializing",
      currentTaskDescription: "Setting up research project",
      completedTasks: [],
      startedAt: new Date().toISOString(),
      estimatedCompletion: new Date(Date.now() + 30 * 60000).toISOString(), // 30 min estimate
    }

    fs.writeFileSync(
      path.join(projectDir, ".research-progress.json"),
      JSON.stringify(progress, null, 2)
    )
  }

  /**
   * Update progress file (called by research agent)
   */
  private updateProgressFile(
    projectDir: string,
    percentage: number,
    currentTask: string,
    completedTasks: string[]
  ) {
    const progressFile = path.join(projectDir, ".research-progress.json")
    const progress: ProgressUpdate = {
      percentage,
      currentTask,
      currentTaskDescription: `Currently working on: ${currentTask}`,
      completedTasks,
      startedAt: new Date().toISOString(),
      estimatedCompletion: new Date(Date.now() + (100 - percentage) * 10000).toISOString(),
    }

    fs.writeFileSync(progressFile, JSON.stringify(progress, null, 2))
  }

  /**
   * Get research status with agent activities
   */
  async getResearchStatus(researchId: string) {
    const research = this.db.getResearch(researchId)
    if (!research) return null

    const agents = this.db.getResearchAgents(researchId)
    const agentsWithActivities = agents.map(agent => ({
      ...agent,
      activities: this.db.getAgentActivities(agent.id),
    }))

    return {
      research,
      agents: agentsWithActivities,
    }
  }

  /**
   * Get all researches with summary
   */
  getAllResearches() {
    const researches = this.db.getAllResearches()
    const stats = this.db.getStats()

    return {
      researches,
      stats,
      recentActivities: this.db.getRecentActivities(20),
    }
  }

  /**
   * Utility: convert to slug
   */
  private slugify(text: string): string {
    return text
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g, "")
      .replace(/[\s_-]+/g, "-")
      .replace(/^-+|-+$/g, "")
      .substring(0, 30)
  }

  close() {
    this.db.close()
  }
}
